name: CI Pipeline

on:
  push:
    branches:
      - develop
    paths-ignore:
      - '**.md' 

jobs:
  # unit-testing:
  #   runs-on: ubuntu-latest
  #   environment: dev
  #   steps:
  #     - uses: actions/checkout@v4
  #     - name: Setup Python 
  #       uses: actions/setup-python@v5
  #       with:
  #         python-version: 3.11
  #     # Install pip, pytest and project dependencies
  #     - name: Install dependencies
  #       run: |
  #         python -m pip install --upgrade pip
  #         pip install pytest
  #         pip install -r requirements.txt              
  #     - name: Test with pytest
  #       env:
  #         PYTHONPATH: flow
  #         PYTHONWARNINGS: ignore::DeprecationWarning,ignore::RemovedInMarshmallow4Warning
  #       run: pytest tests/ --doctest-modules --junitxml=junit/test-results-3.11.xml
  #     - name: Upload pytest test results
  #       uses: actions/upload-artifact@v4
  #       with:
  #         name: pytest-results-3.11
  #         path: junit/test-results-3.11.xml
  #       if: always()

  build-flow:
    # needs: unit-testing
    runs-on: ubuntu-latest
    environment: dev
    env:
      AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
      AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
      AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      AZURE_CREDENTIALS: ${{ secrets.AZURE_CREDENTIALS }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.8'
  
      - name: Install promptflow CLI
        run: |
          python -m pip install --upgrade pip
          pip install promptflow --upgrade

      - name: Verify promptflow CLI installation
        run: pf --version  
      - name: Build Application
        run: |
          # reference: https://github.com/microsoft/promptflow/tree/main/examples/tutorials/flow-deploy/azure-app-service
          pf flow build --source flow --output dist --format docker
        env:
            AZURE_ENV_NAME: ${{ vars.AZURE_ENV_NAME }}
            AZURE_LOCATION: ${{ vars.AZURE_LOCATION }}
            AZURE_SUBSCRIPTION_ID: ${{ vars.AZURE_SUBSCRIPTION_ID }}
      
      - name: Upload dist as artifact
        uses: actions/upload-artifact@v3
        with:
          name: dist-artifact
          path: dist/


  ai-assisted-evaluation:
    needs: build-flow
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
  
      - name: Download dist artifact
        uses: actions/download-artifact@v3
        with:
          name: dist-artifact
  
      - name: List contents of dist
        run: |
          ls -l dist/
        shell: bash
      
  register-flow:
    needs: ai-assisted-evaluation    
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build
        run: |
          echo "TODO: Register Flow"
        shell: bash


  # TODO: Call CD pipeline to provision and deploy the application

